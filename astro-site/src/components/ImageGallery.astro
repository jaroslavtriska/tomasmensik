---
interface Props {
  images: string[];
  videos?: Array<{url?: string; file?: {asset: {_ref: string}}}>;
  title: string;
}

const { images, videos = [], title } = Astro.props;

// Combine images and videos into gallery items
const galleryItems: Array<{type: 'image' | 'video', url: string}> = images.map(url => ({type: 'image', url}));
if (videos && videos.length > 0) {
  videos.forEach((video: any) => {
    if (video.url) {
      galleryItems.push({type: 'video', url: video.url});
    }
  });
}
---

<div class="image-gallery js-gallery" data-gallery-items={JSON.stringify(galleryItems)} data-gallery-title={title}>
  <!-- Main Media -->
  <div 
    class="aspect-[4/3] overflow-hidden cursor-pointer mb-4 rounded-lg focus-within:ring-2 focus-within:ring-accent-500 focus-within:ring-offset-2"
    id="main-media-container"
    role="button"
    tabindex="0"
    aria-label="Klikněte pro zobrazení náhledu"
  >
    {galleryItems[0]?.type === 'image' ? (
      <img 
        id="main-media"
        src={galleryItems[0].url} 
        alt={title}
        class="w-full h-full object-cover transition-opacity duration-300 cursor-pointer"
      />
    ) : galleryItems[0]?.type === 'video' ? (
      <div id="main-media-video" class="w-full h-full cursor-pointer">
        {galleryItems[0].url.includes('youtube.com') || galleryItems[0].url.includes('youtu.be') ? (
          <iframe
            src={galleryItems[0].url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}
            class="w-full h-full"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            muted
          ></iframe>
        ) : galleryItems[0].url.includes('vimeo.com') ? (
          <iframe
            src={galleryItems[0].url.replace('vimeo.com/', 'player.vimeo.com/video/')}
            class="w-full h-full"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            muted
          ></iframe>
        ) : (
          <video
            src={galleryItems[0].url}
            class="w-full h-full object-cover"
            controls
            muted
            playsinline
          ></video>
        )}
      </div>
    ) : null}
  </div>

  <!-- Thumbnails -->
  {galleryItems.length > 1 && (
    <div class="grid grid-cols-5 gap-2">
      {galleryItems.map((item, index) => (
        <button 
          type="button"
          class:list={[
            'thumbnail aspect-square overflow-hidden border-2 transition-all relative cursor-pointer',
            index === 0 ? 'border-accent-700' : 'border-transparent hover:border-accent-300'
          ]}
          data-type={item.type}
          data-url={item.url}
          data-index={index}
        >
          {item.type === 'image' ? (
            <img 
              src={item.url} 
              alt={`${title} - ${index + 1}`}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          ) : (
            <>
              <div class="w-full h-full bg-sand-200 flex items-center justify-center">
                <svg class="w-8 h-8 text-sand-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </>
          )}
        </button>
      ))}
    </div>
  )}

  <!-- Lightbox (uvnitř .js-gallery kvůli event delegation) -->
  <div 
    id="lightbox" 
    class="fixed inset-0 z-50 bg-black/95 hidden items-center justify-center overflow-hidden h-dvh max-h-[100dvh]"
  >
    <button 
      id="lightbox-close"
      type="button"
      class="absolute top-4 right-4 text-white/80 hover:text-white p-2"
      aria-label="Zavřít"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <button 
      id="lightbox-prev"
      type="button"
      class="absolute left-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-2"
      aria-label="Předchozí"
    >
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>

    <button 
      id="lightbox-next"
      type="button"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-2"
      aria-label="Další"
    >
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>

    <div id="lightbox-content" class="max-w-[90vw] max-h-[90dvh] flex items-center justify-center overflow-hidden min-h-0">
      <img 
        id="lightbox-image"
        src="" 
        alt=""
        class="max-w-full max-h-[90dvh] w-auto object-contain hidden"
      />
      <div id="lightbox-video" class="hidden max-w-[90vw] max-h-[90dvh] w-full flex items-center justify-center min-h-0"></div>
    </div>

    <div id="lightbox-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 text-sm">
      1 / {galleryItems.length}
    </div>
  </div>
</div>

<script>
  (function() {
    function getGalleryState(el) {
      const gallery = el.closest('.js-gallery');
      if (!gallery) return null;
      const raw = gallery.getAttribute('data-gallery-items');
      const galleryTitle = gallery.getAttribute('data-gallery-title') || '';
      let items = [];
      try { items = raw ? JSON.parse(raw) : []; } catch (_) {}
      const lightbox = gallery.querySelector('#lightbox');
      return { gallery, items, galleryTitle, lightbox };
    }

    function openLightbox(state, index) {
      if (!state || !state.lightbox || !state.items[index]) return;
      const lightbox = state.lightbox;
      const lightboxImage = lightbox.querySelector('#lightbox-image');
      const lightboxVideo = lightbox.querySelector('#lightbox-video');
      const lightboxContent = lightbox.querySelector('#lightbox-content');
      const lightboxCounter = lightbox.querySelector('#lightbox-counter');
      const item = state.items[index];

      if (item.type === 'image') {
        if (lightboxImage) {
          lightboxImage.src = item.url;
          lightboxImage.alt = state.galleryTitle + ' - ' + (index + 1);
          lightboxImage.classList.remove('hidden');
        }
        if (lightboxVideo) {
          lightboxVideo.innerHTML = '';
          lightboxVideo.classList.add('hidden');
        }
      } else {
        if (lightboxImage) lightboxImage.classList.add('hidden');
        if (lightboxVideo) {
          lightboxVideo.classList.remove('hidden');
          var videoHtml = '';
          if (item.url.indexOf('youtube.com') !== -1 || item.url.indexOf('youtu.be') !== -1) {
            var embedUrl = item.url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
            videoHtml = '<div class="aspect-video max-h-full max-w-full w-full relative"><iframe src="' + embedUrl + '" class="absolute inset-0 w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen muted></iframe></div>';
          } else if (item.url.indexOf('vimeo.com') !== -1) {
            var embedUrl = item.url.replace('vimeo.com/', 'player.vimeo.com/video/');
            videoHtml = '<div class="aspect-video max-h-full max-w-full w-full relative"><iframe src="' + embedUrl + '" class="absolute inset-0 w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen muted></iframe></div>';
          } else {
            videoHtml = '<video src="' + item.url + '" class="max-h-full max-w-full object-contain" controls muted playsinline></video>';
          }
          lightboxVideo.innerHTML = videoHtml;
        }
      }
      if (lightboxCounter) lightboxCounter.textContent = (index + 1) + ' / ' + state.items.length;
      lightbox.dataset.currentIndex = String(index);
      lightbox.classList.remove('hidden');
      lightbox.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox(lightbox) {
      if (lightbox) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = '';
      }
    }

    function setMainMedia(gallery, type, url) {
      const mainContainer = gallery.querySelector('#main-media-container');
      const mainMedia = gallery.querySelector('#main-media');
      const mainMediaVideo = gallery.querySelector('#main-media-video');
      if (!mainContainer) return;
      if (type === 'image' && mainMedia) {
        mainMedia.style.opacity = '0';
        setTimeout(function() {
          mainMedia.src = url;
          mainMedia.style.opacity = '1';
        }, 150);
        if (mainMediaVideo) { mainMediaVideo.innerHTML = ''; mainMediaVideo.style.display = 'none'; }
      } else if (type === 'video' && mainMediaVideo) {
        if (mainMedia) mainMedia.style.display = 'none';
        mainMediaVideo.style.display = 'block';
        var videoHtml = '';
        if (url.indexOf('youtube.com') !== -1 || url.indexOf('youtu.be') !== -1) {
          var embedUrl = url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
          videoHtml = '<div class="aspect-video max-h-full max-w-full w-full relative"><iframe src="' + embedUrl + '" class="absolute inset-0 w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen muted></iframe></div>';
        } else if (url.indexOf('vimeo.com') !== -1) {
          var embedUrl = url.replace('vimeo.com/', 'player.vimeo.com/video/');
          videoHtml = '<div class="aspect-video max-h-full max-w-full w-full relative"><iframe src="' + embedUrl + '" class="absolute inset-0 w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen muted></iframe></div>';
        } else {
          videoHtml = '<video src="' + url + '" class="max-h-full max-w-full object-contain" controls muted playsinline></video>';
        }
        mainMediaVideo.innerHTML = videoHtml;
      }
    }

    document.addEventListener('click', function(e) {
      const thumb = e.target.closest('.thumbnail');
      const mainContainer = e.target.closest('#main-media-container');
      const mainImg = e.target.closest('#main-media');
      const mainVideo = e.target.closest('#main-media-video');

      if (thumb) {
        e.preventDefault();
        const state = getGalleryState(thumb);
        if (!state || !state.items.length) return;
        const index = parseInt(thumb.getAttribute('data-index'), 10);
        if (isNaN(index)) return;
        const type = thumb.getAttribute('data-type');
        const url = thumb.getAttribute('data-url');
        if (type && url) setMainMedia(state.gallery, type, url);
        state.gallery.querySelectorAll('.thumbnail').forEach(function(t, i) {
          t.classList.toggle('border-accent-700', i === index);
          t.classList.toggle('border-transparent', i !== index);
        });
        openLightbox(state, index);
        return;
      }

      if (mainContainer || mainImg || mainVideo) {
        e.preventDefault();
        const state = getGalleryState(mainContainer || mainImg || mainVideo);
        if (!state || !state.items.length) return;
        let index = 0;
        const mainMedia = state.gallery.querySelector('#main-media');
        const mainUrl = mainMedia ? mainMedia.getAttribute('src') : null;
        if (mainUrl) {
          const idx = state.items.findIndex(function(item) { return item.url === mainUrl; });
          if (idx >= 0) index = idx;
        }
        openLightbox(state, index);
      }
    });

    document.addEventListener('keydown', function(e) {
      const lightbox = document.querySelector('#lightbox:not(.hidden)');
      if (!lightbox) return;
      const gallery = lightbox.closest('.js-gallery');
      const state = gallery ? getGalleryState(lightbox) : null;
      if (e.key === 'Escape') {
        closeLightbox(lightbox);
        return;
      }
      if (!state || !state.items.length) return;
      let currentIndex = parseInt(lightbox.dataset.currentIndex, 10) || 0;
      if (e.key === 'ArrowLeft') {
        currentIndex = (currentIndex - 1 + state.items.length) % state.items.length;
        openLightbox(state, currentIndex);
        const item = state.items[currentIndex];
        if (item) setMainMedia(state.gallery, item.type, item.url);
        state.gallery.querySelectorAll('.thumbnail').forEach(function(t, i) {
          t.classList.toggle('border-accent-700', i === currentIndex);
          t.classList.toggle('border-transparent', i !== currentIndex);
        });
      }
      if (e.key === 'ArrowRight') {
        currentIndex = (currentIndex + 1) % state.items.length;
        openLightbox(state, currentIndex);
        const item = state.items[currentIndex];
        if (item) setMainMedia(state.gallery, item.type, item.url);
        state.gallery.querySelectorAll('.thumbnail').forEach(function(t, i) {
          t.classList.toggle('border-accent-700', i === currentIndex);
          t.classList.toggle('border-transparent', i !== currentIndex);
        });
      }
    });

    document.addEventListener('click', function(e) {
      const lightbox = e.target.closest('#lightbox');
      if (!lightbox || e.target !== lightbox) return;
      closeLightbox(lightbox);
    });

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('#lightbox-close, #lightbox-prev, #lightbox-next');
      if (!btn) return;
      e.stopPropagation();
      const lightbox = btn.closest('#lightbox');
      if (!lightbox) return;
      if (btn.id === 'lightbox-close') {
        closeLightbox(lightbox);
        return;
      }
      const gallery = lightbox.closest('.js-gallery');
      const state = gallery ? getGalleryState(lightbox) : null;
      if (!state || !state.items.length) return;
      let currentIndex = parseInt(lightbox.dataset.currentIndex, 10) || 0;
      if (btn.id === 'lightbox-prev') currentIndex = (currentIndex - 1 + state.items.length) % state.items.length;
      if (btn.id === 'lightbox-next') currentIndex = (currentIndex + 1) % state.items.length;
      openLightbox(state, currentIndex);
      const item = state.items[currentIndex];
      if (item) setMainMedia(state.gallery, item.type, item.url);
      state.gallery.querySelectorAll('.thumbnail').forEach(function(t, i) {
        t.classList.toggle('border-accent-700', i === currentIndex);
        t.classList.toggle('border-transparent', i !== currentIndex);
      });
    });
  })();
</script>
