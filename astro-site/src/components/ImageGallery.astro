---
interface Props {
  images: string[];
  videos?: Array<{url?: string; file?: {asset: {_ref: string}}}>;
  title: string;
}

const { images, videos = [], title } = Astro.props;

// Combine images and videos into gallery items
const galleryItems: Array<{type: 'image' | 'video', url: string}> = images.map(url => ({type: 'image', url}));
if (videos && videos.length > 0) {
  videos.forEach((video: any) => {
    if (video.url) {
      galleryItems.push({type: 'video', url: video.url});
    }
  });
}
---

<div class="image-gallery">
  <!-- Main Media -->
  <div 
    class="aspect-[4/3] overflow-hidden cursor-pointer mb-4"
    id="main-media-container"
  >
    {galleryItems[0]?.type === 'image' ? (
      <img 
        id="main-media"
        src={galleryItems[0].url} 
        alt={title}
        class="w-full h-full object-cover transition-opacity duration-300"
      />
    ) : galleryItems[0]?.type === 'video' ? (
      <div id="main-media-video" class="w-full h-full">
        {galleryItems[0].url.includes('youtube.com') || galleryItems[0].url.includes('youtu.be') ? (
          <iframe
            src={galleryItems[0].url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}
            class="w-full h-full"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            muted
          ></iframe>
        ) : galleryItems[0].url.includes('vimeo.com') ? (
          <iframe
            src={galleryItems[0].url.replace('vimeo.com/', 'player.vimeo.com/video/')}
            class="w-full h-full"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            muted
          ></iframe>
        ) : (
          <video
            src={galleryItems[0].url}
            class="w-full h-full object-cover"
            controls
            muted
            playsinline
          ></video>
        )}
      </div>
    ) : null}
  </div>

  <!-- Thumbnails -->
  {galleryItems.length > 1 && (
    <div class="grid grid-cols-5 gap-2">
      {galleryItems.map((item, index) => (
        <button 
          type="button"
          class:list={[
            'thumbnail aspect-square overflow-hidden border-2 transition-all relative cursor-pointer',
            index === 0 ? 'border-accent-700' : 'border-transparent hover:border-accent-300'
          ]}
          data-type={item.type}
          data-url={item.url}
          data-index={index}
        >
          {item.type === 'image' ? (
            <img 
              src={item.url} 
              alt={`${title} - ${index + 1}`}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          ) : (
            <>
              <div class="w-full h-full bg-sand-200 flex items-center justify-center">
                <svg class="w-8 h-8 text-sand-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </>
          )}
        </button>
      ))}
    </div>
  )}
</div>

<!-- Lightbox -->
<div 
  id="lightbox" 
  class="fixed inset-0 z-50 bg-black/95 hidden items-center justify-center"
>
  <button 
    id="lightbox-close"
    class="absolute top-4 right-4 text-white/80 hover:text-white p-2"
    aria-label="Zavřít"
  >
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <button 
    id="lightbox-prev"
    class="absolute left-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-2"
    aria-label="Předchozí"
  >
    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
  </button>

  <button 
    id="lightbox-next"
    class="absolute right-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-2"
    aria-label="Další"
  >
    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  <div id="lightbox-content" class="max-w-[90vw] max-h-[90vh]">
    <img 
      id="lightbox-image"
      src="" 
      alt=""
      class="max-w-full max-h-full object-contain hidden"
    />
    <div id="lightbox-video" class="hidden w-full h-full"></div>
  </div>

  <div id="lightbox-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 text-sm">
    1 / {galleryItems.length}
  </div>
</div>

<script define:vars={{ galleryItems, title }}>
  const mainMedia = document.getElementById('main-media');
  const mainMediaVideo = document.getElementById('main-media-video');
  const mainContainer = document.getElementById('main-media-container');
  const thumbnails = document.querySelectorAll('.thumbnail');
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image');
  const lightboxVideo = document.getElementById('lightbox-video');
  const lightboxContent = document.getElementById('lightbox-content');
  const lightboxClose = document.getElementById('lightbox-close');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxCounter = document.getElementById('lightbox-counter');
  
  let currentIndex = 0;

  function openLightbox() {
    if (lightbox && lightboxContent) {
      updateLightbox();
      lightbox.classList.remove('hidden');
      lightbox.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }
  }

  // Thumbnail click handler – update main media and open lightbox (preview)
  thumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', () => {
      const type = thumb.getAttribute('data-type');
      const url = thumb.getAttribute('data-url');
      if (!url) return;
      
      updateMainMedia(type, url);
      
      // Update thumbnail borders
      thumbnails.forEach(t => t.classList.remove('border-accent-700'));
      thumbnails.forEach(t => t.classList.add('border-transparent'));
      thumb.classList.remove('border-transparent');
      thumb.classList.add('border-accent-700');
      
      currentIndex = index;
      openLightbox();
    });
  });

  function updateMainMedia(type: string | null, url: string) {
    if (!mainContainer) return;
    
    if (type === 'image') {
      if (mainMedia) {
        mainMedia.style.opacity = '0';
        setTimeout(() => {
          if (mainMedia) {
            mainMedia.src = url;
            mainMedia.style.opacity = '1';
          }
        }, 150);
      }
      if (mainMediaVideo) {
        mainMediaVideo.innerHTML = '';
        mainMediaVideo.style.display = 'none';
      }
    } else if (type === 'video') {
      if (mainMedia) {
        mainMedia.style.display = 'none';
      }
      if (mainMediaVideo) {
        mainMediaVideo.style.display = 'block';
        let videoHtml = '';
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
          const embedUrl = url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
          videoHtml = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen muted></iframe>`;
        } else if (url.includes('vimeo.com')) {
          const embedUrl = url.replace('vimeo.com/', 'player.vimeo.com/video/');
          videoHtml = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen muted></iframe>`;
        } else {
          videoHtml = `<video src="${url}" class="w-full h-full object-cover" controls muted playsinline></video>`;
        }
        mainMediaVideo.innerHTML = videoHtml;
      }
    }
  }

  // Open lightbox when clicking main image
  mainContainer?.addEventListener('click', openLightbox);

  // Close lightbox
  lightboxClose?.addEventListener('click', closeLightbox);
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  function closeLightbox() {
    if (lightbox) {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      document.body.style.overflow = '';
    }
  }

  // Navigation
  lightboxPrev?.addEventListener('click', (e) => {
    e.stopPropagation();
    currentIndex = (currentIndex - 1 + galleryItems.length) % galleryItems.length;
    updateLightbox();
    updateMainMedia();
  });

  lightboxNext?.addEventListener('click', (e) => {
    e.stopPropagation();
    currentIndex = (currentIndex + 1) % galleryItems.length;
    updateLightbox();
    updateMainMedia();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('hidden')) {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') {
        currentIndex = (currentIndex - 1 + galleryItems.length) % galleryItems.length;
        updateLightbox();
        updateMainMedia();
      }
      if (e.key === 'ArrowRight') {
        currentIndex = (currentIndex + 1) % galleryItems.length;
        updateLightbox();
        updateMainMedia();
      }
    }
  });

  function updateLightbox() {
    if (!lightboxContent || !galleryItems[currentIndex]) return;
    
    const item = galleryItems[currentIndex];
    if (item.type === 'image') {
      if (lightboxImage) {
        lightboxImage.src = item.url;
        lightboxImage.alt = `${title} - ${currentIndex + 1}`;
        lightboxImage.classList.remove('hidden');
      }
      if (lightboxVideo) {
        lightboxVideo.innerHTML = '';
        lightboxVideo.classList.add('hidden');
      }
    } else if (item.type === 'video') {
      if (lightboxImage) {
        lightboxImage.classList.add('hidden');
      }
      if (lightboxVideo) {
        lightboxVideo.classList.remove('hidden');
        let videoHtml = '';
        if (item.url.includes('youtube.com') || item.url.includes('youtu.be')) {
          const embedUrl = item.url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
          videoHtml = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen muted></iframe>`;
        } else if (item.url.includes('vimeo.com')) {
          const embedUrl = item.url.replace('vimeo.com/', 'player.vimeo.com/video/');
          videoHtml = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen muted></iframe>`;
        } else {
          videoHtml = `<video src="${item.url}" class="w-full h-full object-contain" controls muted playsinline></video>`;
        }
        lightboxVideo.innerHTML = videoHtml;
      }
    }
    updateCounter();
  }

  function updateMainMedia() {
    if (!galleryItems[currentIndex]) return;
    const item = galleryItems[currentIndex];
    updateMainMedia(item.type, item.url);
    
    thumbnails.forEach((t, i) => {
      t.classList.toggle('border-accent-700', i === currentIndex);
      t.classList.toggle('border-transparent', i !== currentIndex);
    });
  }

  function updateCounter() {
    if (lightboxCounter) {
      lightboxCounter.textContent = `${currentIndex + 1} / ${galleryItems.length}`;
    }
  }
</script>
