---
import { urlFor, getVideoUrlFromFile, getVideoThumbnailUrl, getVideoEmbedUrl } from '../lib/sanity';

interface Props {
  content: Array<{
    _type: string;
    _key: string;
    style?: string;
    children?: Array<{
      _type: string;
      _key: string;
      text: string;
      marks?: string[];
    }>;
    markDefs?: Array<{
      _type: string;
      _key: string;
      href?: string;
    }>;
    asset?: {
      _ref: string;
      _type: string;
    };
    crop?: { top: number; bottom: number; left: number; right: number };
    hotspot?: { x: number; y: number; height: number; width: number };
    alt?: string;
    videoUrl?: string;
    videoFile?: { asset: { _ref: string } };
    poster?: { asset?: { _ref: string } };
    aspectRatio?: '16/9' | '9/16' | '4/3' | '1/1';
  }>;
}

const { content } = Astro.props;

if (!content || !Array.isArray(content) || content.length === 0) {
  return null;
}

// Filter out empty blocks
const validBlocks = content.filter((block) => {
  if (block._type === 'block' && block.children) {
    const hasText = block.children.some((child: any) => child.text && child.text.trim());
    return hasText;
  }
  if (block._type === 'image' && block.asset) {
    return true;
  }
  if (block._type === 'video' && (block.videoUrl || block.videoFile)) {
    return true;
  }
  return false;
});

if (validBlocks.length === 0) {
  return null;
}

// Helper to get image URL - pass full image object to preserve crop/hotspot
const getImageUrl = (imageBlock: any) => {
  if (!imageBlock?.asset?._ref) return null;
  return urlFor(imageBlock).width(1200).fit('max').auto('format').url();
};

// Helper to get video URL and thumbnail for video block
const getVideoBlockData = (videoBlock: any) => {
  const videoUrl = videoBlock.videoUrl || (videoBlock.videoFile ? getVideoUrlFromFile(videoBlock.videoFile) : null);
  if (!videoUrl) return null;
  const posterUrl = videoBlock.poster?.asset
    ? urlFor(videoBlock.poster).width(1200).fit('max').auto('format').url()
    : getVideoThumbnailUrl(videoUrl);
  const embedUrl = getVideoEmbedUrl(videoUrl);
  const isEmbed = !!(embedUrl && (videoUrl.includes('youtube') || videoUrl.includes('vimeo')));
  return { videoUrl, posterUrl, embedUrl, isEmbed };
};

const aspectRatioClass: Record<string, string> = {
  '16/9': 'aspect-video',
  '9/16': 'aspect-[9/16]',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
};

// Helper to render marks (bold, italic, links)
const renderMarks = (text: string, marks: any[] = [], markDefs: any[] = []) => {
  let result = text;
  
  if (!marks || marks.length === 0) {
    return result;
  }
  
  // Find link mark first
  const linkMark = marks.find((mark) => {
    if (typeof mark === 'object' && mark?._type === 'link') return true;
    if (typeof mark === 'string' && mark.startsWith('link')) return true;
    return false;
  });
  
  // Apply link if found
  if (linkMark) {
    let linkKey = '';
    if (typeof linkMark === 'object' && linkMark._key) {
      linkKey = linkMark._key;
    } else if (typeof linkMark === 'string') {
      linkKey = linkMark.replace('link-', '');
    }
    
    const linkDef = markDefs?.find((def) => def._key === linkKey);
    if (linkDef?.href) {
      result = `<a href="${linkDef.href}" class="text-accent-700 hover:text-accent-800 underline">${result}</a>`;
    }
  }
  
  // Apply other marks
  marks.forEach((mark) => {
    if (typeof mark === 'string') {
      if (mark === 'strong') {
        result = `<strong>${result}</strong>`;
      } else if (mark === 'em') {
        result = `<em>${result}</em>`;
      }
    }
  });
  
  return result;
};
---

<div class="prose prose-lg max-w-none text-sand-700">
  {validBlocks.map((block) => {
    if (block._type === 'image' && block.asset) {
      const imageUrl = getImageUrl(block);
      if (!imageUrl) return null;
      
      return (
        <figure class="my-8">
          <img 
            src={imageUrl} 
            alt={block.alt || ''}
            class="w-full h-auto rounded-lg"
          />
          {block.alt && (
            <figcaption class="text-sm text-sand-500 mt-2 text-center">
              {block.alt}
            </figcaption>
          )}
        </figure>
      );
    }

    if (block._type === 'video') {
      const videoData = getVideoBlockData(block);
      if (!videoData) return null;
      const { videoUrl, posterUrl, embedUrl, isEmbed } = videoData;
      const aspectClass = aspectRatioClass[block.aspectRatio || '16/9'] || 'aspect-video';
      
      return (
        <figure class="my-8">
          <div 
            class={`inline-video ${aspectClass} w-full max-w-2xl rounded-lg overflow-hidden bg-sand-200 cursor-pointer group relative`}
            data-video-url={videoUrl}
            data-embed-url={embedUrl || ''}
            data-is-embed={isEmbed}
          >
            <div class="inline-video-poster absolute inset-0">
              {posterUrl ? (
                <img 
                  src={posterUrl} 
                  alt="NÃ¡hled videa"
                  class="w-full h-full object-contain"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center bg-sand-300" />
              )}
              <div class="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/30 transition-colors">
                <div class="w-16 h-16 rounded-full bg-white/90 flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg">
                  <svg class="w-8 h-8 text-accent-700 ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </figure>
      );
    }
    
    if (block._type === 'block' && block.children) {
      const text = block.children.map((child: any) => {
        if (child._type === 'span' && child.text) {
          return renderMarks(child.text, child.marks || [], block.markDefs || []);
        }
        return '';
      }).join('');
      
      if (!text.trim()) return null;
      
      const Tag = block.style === 'h2' ? 'h2' : block.style === 'h3' ? 'h3' : 'p';
      const className = block.style === 'h2' 
        ? 'font-heading text-3xl text-sand-900 mt-8 mb-4' 
        : block.style === 'h3'
        ? 'font-heading text-2xl text-sand-900 mt-6 mb-3'
        : 'mb-4 leading-relaxed';
      
      return (
        <Tag class={className} set:html={text} />
      );
    }
    
    return null;
  })}
</div>

<script>
  document.querySelectorAll('.inline-video').forEach((el) => {
    if ((el as HTMLElement).dataset.played === 'true') return;
    el.addEventListener('click', function () {
      const videoUrl = (el as HTMLElement).dataset.videoUrl;
      const embedUrl = (el as HTMLElement).dataset.embedUrl;
      const isEmbed = (el as HTMLElement).dataset.isEmbed === 'true';
      const poster = el.querySelector('.inline-video-poster');
      if (!poster || !videoUrl) return;
      poster.remove();
      if (isEmbed && embedUrl) {
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.className = 'absolute inset-0 w-full h-full';
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        iframe.setAttribute('allowfullscreen', '');
        el.appendChild(iframe);
      } else {
        const video = document.createElement('video');
        video.src = videoUrl;
        video.className = 'absolute inset-0 w-full h-full object-contain';
        video.controls = true;
        video.autoplay = true;
        video.playsInline = true;
        el.appendChild(video);
      }
      (el as HTMLElement).dataset.played = 'true';
    });
  });
</script>
