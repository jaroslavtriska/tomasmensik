---
import { urlFor } from '../lib/sanity';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface Props {
  content: Array<{
    _type: string;
    _key: string;
    style?: string;
    children?: Array<{
      _type: string;
      _key: string;
      text: string;
      marks?: string[];
    }>;
    markDefs?: Array<{
      _type: string;
      _key: string;
      href?: string;
    }>;
    asset?: {
      _ref: string;
      _type: string;
    };
    crop?: {
      top: number;
      bottom: number;
      left: number;
      right: number;
    };
    hotspot?: {
      x: number;
      y: number;
      height: number;
      width: number;
    };
    alt?: string;
  }>;
}

const { content } = Astro.props;

if (!content || !Array.isArray(content) || content.length === 0) {
  return null;
}

// Filter out empty blocks
const validBlocks = content.filter((block) => {
  if (block._type === 'block' && block.children) {
    const hasText = block.children.some((child: any) => child.text && child.text.trim());
    return hasText;
  }
  if (block._type === 'image' && block.asset) {
    return true;
  }
  return false;
});

if (validBlocks.length === 0) {
  return null;
}

// Helper to get image URL - pass full image object to preserve crop/hotspot
const getImageUrl = (imageBlock: any) => {
  if (!imageBlock?.asset?._ref) return null;
  // Pass the full image object to urlFor - it will automatically apply crop/hotspot
  return urlFor(imageBlock).width(1200).fit('max').auto('format').url();
};

// Helper to render marks (bold, italic, links)
const renderMarks = (text: string, marks: any[] = [], markDefs: any[] = []) => {
  let result = text;
  
  if (!marks || marks.length === 0) {
    return result;
  }
  
  // Find link mark first
  const linkMark = marks.find((mark) => {
    if (typeof mark === 'object' && mark?._type === 'link') return true;
    if (typeof mark === 'string' && mark.startsWith('link')) return true;
    return false;
  });
  
  // Apply link if found
  if (linkMark) {
    let linkKey = '';
    if (typeof linkMark === 'object' && linkMark._key) {
      linkKey = linkMark._key;
    } else if (typeof linkMark === 'string') {
      linkKey = linkMark.replace('link-', '');
    }
    
    const linkDef = markDefs?.find((def) => def._key === linkKey);
    if (linkDef?.href) {
      result = `<a href="${linkDef.href}" class="text-accent-700 hover:text-accent-800 underline">${result}</a>`;
    }
  }
  
  // Apply other marks
  marks.forEach((mark) => {
    if (typeof mark === 'string') {
      if (mark === 'strong') {
        result = `<strong>${result}</strong>`;
      } else if (mark === 'em') {
        result = `<em>${result}</em>`;
      }
    }
  });
  
  return result;
};
---

<div class="prose prose-lg max-w-none text-sand-700">
  {validBlocks.map((block) => {
    if (block._type === 'image' && block.asset) {
      const imageUrl = getImageUrl(block);
      if (!imageUrl) return null;
      
      return (
        <figure class="my-8">
          <img 
            src={imageUrl} 
            alt={block.alt || ''}
            class="w-full h-auto rounded-lg"
          />
          {block.alt && (
            <figcaption class="text-sm text-sand-500 mt-2 text-center">
              {block.alt}
            </figcaption>
          )}
        </figure>
      );
    }
    
    if (block._type === 'block' && block.children) {
      const text = block.children.map((child: any) => {
        if (child._type === 'span' && child.text) {
          return renderMarks(child.text, child.marks || [], block.markDefs || []);
        }
        return '';
      }).join('');
      
      if (!text.trim()) return null;
      
      const Tag = block.style === 'h2' ? 'h2' : block.style === 'h3' ? 'h3' : 'p';
      const className = block.style === 'h2' 
        ? 'font-heading text-3xl text-sand-900 mt-8 mb-4' 
        : block.style === 'h3'
        ? 'font-heading text-2xl text-sand-900 mt-6 mb-3'
        : 'mb-4 leading-relaxed';
      
      return (
        <Tag class={className} set:html={text} />
      );
    }
    
    return null;
  })}
</div>
