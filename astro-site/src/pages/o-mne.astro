---
import Layout from '../layouts/Layout.astro';
import { client, queries } from '../lib/sanity';
import type { SanityAbout } from '../lib/sanity';

// Fetch about data from Sanity with error handling
let about: SanityAbout | null = null;
try {
  about = await client.fetch<SanityAbout>(queries.about);
} catch (error) {
  console.error('Error fetching about data:', error);
  about = null;
}

// Build image URL helper
const getImageUrl = (ref: string) => {
  if (!ref) return null;
  const projectId = import.meta.env.PUBLIC_SANITY_PROJECT_ID || '2mnybhg0';
  const dataset = import.meta.env.PUBLIC_SANITY_DATASET || 'production';
  return `https://cdn.sanity.io/images/${projectId}/${dataset}/${ref.replace('image-', '').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`;
};

// Helper to get video URL from Sanity file asset – podpora .mp4, .mov, .webm
const getVideoUrl = (fileAsset: { asset: { _ref: string } } | undefined) => {
  if (!fileAsset?.asset?._ref) return null;
  const ref = fileAsset.asset._ref;
  const extMatch = ref.match(/-(\w+)$/);
  const ext = extMatch && ['mp4', 'mov', 'webm'].includes(extMatch[1]) ? extMatch[1] : 'mp4';
  const fileId = ref.replace(/^file-/, '').replace(/-\w+$/, '');
  const projectId = import.meta.env.PUBLIC_SANITY_PROJECT_ID || '2mnybhg0';
  const dataset = import.meta.env.PUBLIC_SANITY_DATASET || 'production';
  return `https://cdn.sanity.io/files/${projectId}/${dataset}/${fileId}.${ext}`;
};

// Default values if no content in Sanity
const name = about?.name || 'Tomáš Menšík';
const subtitle = about?.subtitle || 'Váš realitní partner v Jihlavě';
const bio = about?.bio || 'Jsem realitní makléř s více než 5 lety zkušeností v oboru.';
const interests = about?.interests || ['Cyklistika', 'Běh', 'Cestování', 'Rodina'];
const stats = about?.stats || [
  { number: '100+', label: 'Prodaných nemovitostí' },
  { number: '5+', label: 'Let zkušeností' },
  { number: '98%', label: 'Spokojených klientů' },
];

// Get main media (video has priority over photo)
const mainVideoUrl = about?.mainVideo?.url || (about?.mainVideo?.file ? getVideoUrl(about.mainVideo.file) : null);
const mainPhoto = about?.mainPhoto?.asset?._ref ? getImageUrl(about.mainPhoto.asset._ref) : 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=600&h=800&fit=crop';
const hasMainVideo = !!mainVideoUrl;

// Get photos and media
const photos = about?.photos?.map((p: any) => getImageUrl(p.asset._ref)).filter(Boolean) || [];
const mediaItems = about?.media?.map((item: any) => {
  if (item.type === 'image' && item.image?.asset?._ref) {
    return { type: 'image', url: getImageUrl(item.image.asset._ref) };
  } else if (item.type === 'video') {
    const videoUrl = item.videoUrl || (item.videoFile ? getVideoUrl(item.videoFile) : null);
    return videoUrl ? { type: 'video', url: videoUrl } : null;
  }
  return null;
}).filter(Boolean) || [];

// Combine photos and media for gallery
const galleryItems = [...photos.map((url: string) => ({ type: 'image', url })), ...mediaItems];
---

<Layout title="O mně" description="Poznejte Tomáše Menšíka - vašeho realitního partnera v Jihlavě a okolí.">
  <!-- Hero -->
  <section class="py-20 bg-sand-100">
    <div class="container-narrow">
      <div class="max-w-3xl">
        <p class="text-accent-700 font-medium tracking-widest uppercase text-sm mb-4 animate-fade-in">
          O mně
        </p>
        <h1 class="font-heading text-5xl md:text-6xl text-sand-900 mb-6 animate-fade-in animate-delay-100">
          {name}
        </h1>
        <p class="text-sand-600 text-xl animate-fade-in animate-delay-200">
          {subtitle}
        </p>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-24">
    <div class="container-narrow">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
        <!-- Bio -->
        <div>
          <div class="prose prose-lg text-sand-700 whitespace-pre-line mb-12">
            {bio}
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-6 p-8 bg-sand-100">
            {stats.map((stat: any) => (
              <div class="text-center">
                <div class="font-heading text-3xl md:text-4xl text-accent-700 font-semibold mb-1">
                  {stat.number}
                </div>
                <div class="text-sm text-sand-600">
                  {stat.label}
                </div>
              </div>
            ))}
          </div>

          <!-- Interests -->
          <div class="mt-12">
            <h3 class="font-heading text-2xl text-sand-900 mb-4">Koníčky a zájmy</h3>
            <div class="flex flex-wrap gap-3">
              {interests.map((interest: string) => (
                <span class="px-4 py-2 bg-accent-100 text-accent-800 text-sm font-medium">
                  {interest}
                </span>
              ))}
            </div>
          </div>
        </div>

        <!-- Photos & Media -->
        <div class="space-y-6">
          <!-- Main media (video or photo) -->
          <div class="aspect-[3/4] overflow-hidden">
            {hasMainVideo ? (
              <video 
                src={mainVideoUrl} 
                controls
                muted
                playsinline
                class="w-full h-full object-cover"
              ></video>
            ) : (
              <img 
                src={mainPhoto} 
                alt={name}
                class="w-full h-full object-cover"
              />
            )}
          </div>
          
          <!-- Media grid -->
          {galleryItems.length > 0 && (
            <div class="grid grid-cols-3 gap-4">
              {galleryItems.slice(0, 3).map((item: any, index: number) => (
                <div class="aspect-square overflow-hidden">
                  {item.type === 'video' ? (
                    <video 
                      src={item.url} 
                      controls
                      muted
                      playsinline
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                    ></video>
                  ) : (
                    <img 
                      src={item.url} 
                      alt={`Fotografie ${index + 2}`}
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                    />
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="py-20 bg-accent-800 text-white">
    <div class="container-narrow text-center">
      <h2 class="font-heading text-4xl mb-6 text-white">Pojďme spolupracovat</h2>
      <p class="text-white/80 max-w-2xl mx-auto mb-8">
        Máte zájem o mé služby nebo se chcete na něco zeptat? 
        Neváhejte mě kontaktovat, rád vám pomohu.
      </p>
      <a href="/kariera" class="btn btn-primary bg-accent-600 hover:bg-accent-500">
        Pojďme spolupracovat
      </a>
    </div>
  </section>
</Layout>
