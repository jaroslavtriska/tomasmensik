---
import Layout from '../layouts/Layout.astro';
import { client, queries, urlFor } from '../lib/sanity';
import type { SanityPageCareer, SanityAbout } from '../lib/sanity';

// Web3Forms configuration (free, unlimited submissions)
// Get your access key from https://web3forms.com (no registration needed, just enter your email)
const WEB3FORMS_ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
const formAction = WEB3FORMS_ACCESS_KEY ? 'https://api.web3forms.com/submit' : '#';

let pageCareer: SanityPageCareer | null = null;
let about: SanityAbout | null = null;
try {
  pageCareer = await client.fetch<SanityPageCareer>(queries.pageCareer);
  about = await client.fetch<SanityAbout>(queries.about);
} catch (error) {
  console.error('Chyba při načítání dat pro stránku kariéra:', error);
}

const title = pageCareer?.careerTitle || 'Kariéra';
const subtitle =
  pageCareer?.careerSubtitle ||
  'Chcete s Tomášem spolupracovat? Napište pár vět o sobě a ozveme se vám.';

// Photo: career page photo first, fallback to about mainPhoto
const getImageUrl = (ref: string) => {
  if (!ref) return null;
  return `https://cdn.sanity.io/images/2mnybhg0/production/${ref.replace('image-', '').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`;
};
const careerPhotoUrl = pageCareer?.careerPhoto ? urlFor(pageCareer.careerPhoto).width(600).height(800).fit('max').auto('format').url() : null;
const aboutPhotoUrl = about?.mainPhoto?.asset?._ref ? getImageUrl(about.mainPhoto.asset._ref) : null;
const tomasPhoto = careerPhotoUrl || aboutPhotoUrl || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=600&h=800&fit=crop';
const tomasName = about?.name || 'Tomáš Menšík';
---

<Layout title={title}>
  <section class="py-20 bg-sand-100">
    <div class="container-narrow">
      <div class="max-w-3xl">
        <p class="text-accent-700 font-medium tracking-widest uppercase text-sm mb-4 animate-fade-in">
          Kariéra
        </p>
        <h1 class="font-heading text-5xl md:text-6xl text-sand-900 mb-6 animate-fade-in animate-delay-100">
          {title}
        </h1>
        <p class="text-sand-600 text-xl animate-fade-in animate-delay-200">
          {subtitle}
        </p>
      </div>
    </div>
  </section>

  <section class="py-24">
    <div class="container-narrow">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
        <!-- Tomáš's Photo -->
        <div class="order-2 lg:order-1">
          <div class="aspect-[3/4] overflow-hidden max-w-md mx-auto lg:mx-0">
            <img 
              src={tomasPhoto} 
              alt={tomasName}
              class="w-full h-full object-cover"
            />
          </div>
        </div>

        <!-- Form -->
        <div class="order-1 lg:order-2 bg-white border border-sand-200 p-8 md:p-10">
          <div id="form-content">
            <h2 class="font-heading text-2xl text-sand-900 mb-6">
              Napište pár slov o sobě
            </h2>
            <p class="text-sand-600 mb-8 text-sm">
              Vyplňte prosím formulář níže. Krátce popište svou zkušenost a představu o spolupráci.
              Ozvu se vám co nejdříve.
            </p>

            <form
            id="career-form"
            method="POST"
            action={formAction}
            class="space-y-6"
          >
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="firstName" class="block text-sm font-medium text-sand-700 mb-1">
                Jméno
              </label>
              <input
                id="firstName"
                name="firstName"
                type="text"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-sand-700 mb-1">
                Příjmení
              </label>
              <input
                id="lastName"
                name="lastName"
                type="text"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="phone" class="block text-sm font-medium text-sand-700 mb-1">
                Telefon
              </label>
              <input
                id="phone"
                name="phone"
                type="tel"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-sand-700 mb-1">
                E‑mail
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
          </div>

          <div>
            <label for="message" class="block text-sm font-medium text-sand-700 mb-1">
              Něco o vás a o představě spolupráce
            </label>
            <textarea
              id="message"
              name="message"
              rows={5}
              required
              class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white resize-vertical"
            />
          </div>

          <input type="hidden" name="access_key" value={WEB3FORMS_ACCESS_KEY || ''} />
          <input type="hidden" name="subject" value="Nová kariérní zpráva z webu" />
          <input type="hidden" name="form_name" value="Kariera" />
          <input type="hidden" name="from_name" value="Tomáš Menšík - Web" />

          <button
            type="submit"
            class="btn btn-primary w-full md:w-auto"
            disabled={!WEB3FORMS_ACCESS_KEY}
          >
            Odeslat zprávu
          </button>

          {!WEB3FORMS_ACCESS_KEY && (
            <p class="text-xs text-red-500 mt-2">
              Formulář není plně nastaven – chybí <code>PUBLIC_WEB3FORMS_ACCESS_KEY</code> v&nbsp;.env.
            </p>
          )}
          </form>
          </div>

          <!-- Success message (hidden by default) -->
          <div id="form-success" class="hidden text-center py-12">
            <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h3 class="font-heading text-2xl text-sand-900 mb-2">Děkuji za zprávu!</h3>
            <p class="text-sand-600">
              Vaše zpráva byla úspěšně odeslána. Ozvu se vám co nejdříve.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('career-form') as HTMLFormElement;
  const formContent = document.getElementById('form-content');
  const successMessage = document.getElementById('form-success');

  // Nastavení českých validačních zpráv pro všechny required pole
  if (form) {
    const firstName = form.querySelector('#firstName') as HTMLInputElement;
    const lastName = form.querySelector('#lastName') as HTMLInputElement;
    const phone = form.querySelector('#phone') as HTMLInputElement;
    const email = form.querySelector('#email') as HTMLInputElement;
    const message = form.querySelector('#message') as HTMLTextAreaElement;

    // Nastavení custom validačních zpráv
    if (firstName) {
      firstName.addEventListener('invalid', () => {
        firstName.setCustomValidity('Prosím vyplňte jméno.');
      });
      firstName.addEventListener('input', () => {
        firstName.setCustomValidity('');
      });
    }

    if (lastName) {
      lastName.addEventListener('invalid', () => {
        lastName.setCustomValidity('Prosím vyplňte příjmení.');
      });
      lastName.addEventListener('input', () => {
        lastName.setCustomValidity('');
      });
    }

    if (phone) {
      phone.addEventListener('invalid', () => {
        phone.setCustomValidity('Prosím vyplňte telefonní číslo.');
      });
      phone.addEventListener('input', () => {
        phone.setCustomValidity('');
      });
    }

    if (email) {
      email.addEventListener('invalid', () => {
        if (email.validity.valueMissing) {
          email.setCustomValidity('Prosím vyplňte emailovou adresu.');
        } else if (email.validity.typeMismatch) {
          email.setCustomValidity('Prosím zadejte platnou emailovou adresu.');
        }
      });
      email.addEventListener('input', () => {
        email.setCustomValidity('');
      });
    }

    if (message) {
      message.addEventListener('invalid', () => {
        message.setCustomValidity('Prosím vyplňte zprávu o sobě a představě spolupráce.');
      });
      message.addEventListener('input', () => {
        message.setCustomValidity('');
      });
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      const result = await response.json();

      if (response.ok && result.success) {
        // Skryj celý obsah formuláře včetně nadpisu a popisného textu
        formContent?.style.setProperty('display', 'none');
        // Zobraz success message
        successMessage?.classList.remove('hidden');
      } else {
        // Zobraz konkrétní chybovou zprávu z API, pokud je k dispozici
        const errorMessage = result.message || 'Nepodařilo se odeslat formulář. Zkuste to prosím znovu.';
        alert(`Chyba: ${errorMessage}`);
      }
    } catch (error) {
      console.error('Chyba při odesílání kariérního formuláře:', error);
      alert('Došlo k chybě při odesílání formuláře. Zkontrolujte prosím připojení k internetu a zkuste to znovu.');
    }
  });
</script>

