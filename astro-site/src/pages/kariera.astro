---
import Layout from '../layouts/Layout.astro';
import { client, queries } from '../lib/sanity';
import type { SanitySiteSettings, SanityAbout } from '../lib/sanity';

const FORMSPREE_ID = import.meta.env.PUBLIC_FORMSPREE_ID;
const formAction = FORMSPREE_ID ? `https://formspree.io/f/${FORMSPREE_ID}` : '#';

let siteSettings: SanitySiteSettings | null = null;
let about: SanityAbout | null = null;
try {
  siteSettings = await client.fetch<SanitySiteSettings>(queries.siteSettings);
  about = await client.fetch<SanityAbout>(queries.about);
} catch (error) {
  console.error('Error fetching data for career page:', error);
}

const title = siteSettings?.careerTitle || 'Kariéra';
const subtitle =
  siteSettings?.careerSubtitle ||
  'Chcete s Tomášem spolupracovat? Napište pár vět o sobě a ozveme se vám.';

// Get Tomáš's photo
const getImageUrl = (ref: string) => {
  if (!ref) return null;
  return `https://cdn.sanity.io/images/2mnybhg0/production/${ref.replace('image-', '').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`;
};

const tomasPhoto = about?.mainPhoto?.asset?._ref ? getImageUrl(about.mainPhoto.asset._ref) : 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=600&h=800&fit=crop';
const tomasName = about?.name || 'Tomáš Menšík';
---

<Layout title={title}>
  <section class="py-20 bg-sand-100">
    <div class="container-narrow">
      <div class="max-w-3xl">
        <p class="text-accent-700 font-medium tracking-widest uppercase text-sm mb-4 animate-fade-in">
          Kariéra
        </p>
        <h1 class="font-heading text-5xl md:text-6xl text-sand-900 mb-6 animate-fade-in animate-delay-100">
          {title}
        </h1>
        <p class="text-sand-600 text-xl animate-fade-in animate-delay-200">
          {subtitle}
        </p>
      </div>
    </div>
  </section>

  <section class="py-24">
    <div class="container-narrow">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
        <!-- Tomáš's Photo -->
        <div class="order-2 lg:order-1">
          <div class="aspect-[3/4] overflow-hidden max-w-md mx-auto lg:mx-0">
            <img 
              src={tomasPhoto} 
              alt={tomasName}
              class="w-full h-full object-cover"
            />
          </div>
        </div>

        <!-- Form -->
        <div class="order-1 lg:order-2 bg-white border border-sand-200 p-8 md:p-10">
          <h2 class="font-heading text-2xl text-sand-900 mb-6">
            Napište pár slov o sobě
          </h2>
          <p class="text-sand-600 mb-8 text-sm">
            Vyplňte prosím formulář níže. Krátce popište svou zkušenost a představu o spolupráci.
            Ozvu se vám co nejdříve.
          </p>

          <form
            method="POST"
            action={formAction}
            class="space-y-6"
          >
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="firstName" class="block text-sm font-medium text-sand-700 mb-1">
                Jméno
              </label>
              <input
                id="firstName"
                name="firstName"
                type="text"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-sand-700 mb-1">
                Příjmení
              </label>
              <input
                id="lastName"
                name="lastName"
                type="text"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="phone" class="block text-sm font-medium text-sand-700 mb-1">
                Telefon
              </label>
              <input
                id="phone"
                name="phone"
                type="tel"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-sand-700 mb-1">
                E‑mail
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white"
              />
            </div>
          </div>

          <div>
            <label for="message" class="block text-sm font-medium text-sand-700 mb-1">
              Něco o vás a o představě spolupráce
            </label>
            <textarea
              id="message"
              name="message"
              rows={5}
              required
              class="w-full border border-sand-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-accent-500 bg-white resize-vertical"
            />
          </div>

          <input type="hidden" name="_subject" value="Nová kariérní zpráva z webu" />
          <input type="hidden" name="formName" value="Kariera" />

          <button
            type="submit"
            class="btn btn-primary w-full md:w-auto"
            disabled={!FORMSPREE_ID}
          >
            Odeslat zprávu
          </button>

          {!FORMSPREE_ID && (
            <p class="text-xs text-red-500 mt-2">
              Formulář není plně nastaven – chybí <code>PUBLIC_FORMSPREE_ID</code> v&nbsp;.env.
            </p>
          )}
          </form>
        </div>
      </div>
    </div>
  </section>
</Layout>

