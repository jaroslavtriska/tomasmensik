---
import Layout from '../../layouts/Layout.astro';
import ImageGallery from '../../components/ImageGallery.astro';
import { client, queries, formatPrice } from '../../lib/sanity';
import type { SanityProperty, SanitySiteSettings } from '../../lib/sanity';

// Fetch all properties for static paths
export async function getStaticPaths() {
  try {
    const properties = await client.fetch<SanityProperty[]>(`*[_type == "property"]`) || [];
    
    return properties.map((property) => ({
      params: { slug: property.slug.current },
      props: { property },
    }));
  } catch (error) {
    console.error('Error fetching properties for static paths:', error);
    return [];
  }
}

const { property } = Astro.props;
let siteSettings: SanitySiteSettings | null = null;
try {
  siteSettings = await client.fetch<SanitySiteSettings>(queries.siteSettings);
} catch (error) {
  console.error('Error fetching site settings:', error);
  siteSettings = null;
}

// Build image URLs
const getImageUrl = (ref: string) => {
  if (!ref) return null;
  return `https://cdn.sanity.io/images/2mnybhg0/production/${ref.replace('image-', '').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`;
};

const mainImageUrl = property.mainImage?.asset?._ref ? getImageUrl(property.mainImage.asset._ref) : 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=1200&h=800&fit=crop';
const images = property.images?.map((img: any) => getImageUrl(img.asset._ref)).filter(Boolean) || [];
if (!images.includes(mainImageUrl)) {
  images.unshift(mainImageUrl);
}

// Prepare gallery items (images + videos)
const galleryItems: Array<{type: 'image' | 'video', url: string}> = images.map(url => ({type: 'image', url}));
if (property.videos) {
  property.videos.forEach((video: any) => {
    if (video.url) {
      galleryItems.push({type: 'video', url: video.url});
    }
  });
}

const phone = siteSettings?.phone || '+420 123 456 789';
const email = siteSettings?.email || 'tomas@mensik-reality.cz';
const formattedPrice = formatPrice(property.price);
const typeLabel = property.type === 'prodej' ? 'Prodej' : 'Pronájem';
---

<Layout title={property.title} description={`${typeLabel} - ${property.title} v lokalitě ${property.location}. Cena: ${formattedPrice}`}>
  <!-- Breadcrumb -->
  <section class="py-4 bg-sand-100 border-b border-sand-200">
    <div class="container-narrow">
      <nav class="flex items-center gap-2 text-sm text-sand-500">
        <a href="/" class="hover:text-accent-700 transition-colors">Úvod</a>
        <span>/</span>
        <a href="/nemovitosti" class="hover:text-accent-700 transition-colors">Nemovitosti</a>
        <span>/</span>
        <span class="text-sand-900">{property.title}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12">
    <div class="container-narrow">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Left Column - Images & Description -->
        <div class="lg:col-span-2">
          <!-- Gallery -->
          <ImageGallery images={images} videos={property.videos} title={property.title} />

          <!-- Description -->
          {property.description && (
            <div class="mt-12">
              <h2 class="font-heading text-2xl text-sand-900 mb-4">Popis nemovitosti</h2>
              <div class="prose prose-sand max-w-none text-sand-700 whitespace-pre-line">
                {property.description}
              </div>
            </div>
          )}

          <!-- Location -->
          <div class="mt-12">
            <h2 class="font-heading text-2xl text-sand-900 mb-4">Lokalita</h2>
            <div class="flex items-start gap-3 text-sand-700">
              <svg class="w-5 h-5 text-accent-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span>{property.address || property.location}</span>
            </div>
            <!-- Map placeholder -->
            <div class="mt-4 aspect-video bg-sand-200 flex items-center justify-center">
              <p class="text-sand-500">Mapa bude doplněna</p>
            </div>
          </div>
        </div>

        <!-- Right Column - Info & Contact -->
        <div class="lg:col-span-1">
          <div class="sticky top-28">
            <!-- Price Card -->
            <div class="bg-white border border-sand-200 p-6 mb-6">
              <span class="inline-block px-3 py-1 bg-accent-700 text-white text-xs font-medium tracking-wide uppercase mb-4">
                {typeLabel}
              </span>
              <h1 class="font-heading text-2xl text-sand-900 mb-2">
                {property.title}
              </h1>
              <div class="flex items-center gap-2 text-sand-500 text-sm mb-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>{property.location}</span>
              </div>
              <div class="font-heading text-3xl text-accent-700 font-semibold">
                {formattedPrice}
              </div>
              {property.priceNote && (
                <p class="text-sand-500 text-sm mt-1">{property.priceNote}</p>
              )}
            </div>

            <!-- Parameters -->
            {property.parameters && property.parameters.length > 0 && (
              <div class="bg-white border border-sand-200 p-6 mb-6">
                <h3 class="font-heading text-lg text-sand-900 mb-4">Parametry</h3>
                <dl class="space-y-3">
                  {property.area && (
                    <div class="flex justify-between text-sm">
                      <dt class="text-sand-500">Plocha</dt>
                      <dd class="text-sand-900 font-medium">{property.area} m²</dd>
                    </div>
                  )}
                  {property.disposition && (
                    <div class="flex justify-between text-sm">
                      <dt class="text-sand-500">Dispozice</dt>
                      <dd class="text-sand-900 font-medium">{property.disposition}</dd>
                    </div>
                  )}
                  {property.parameters.map((param: any) => (
                    <div class="flex justify-between text-sm">
                      <dt class="text-sand-500">{param.label}</dt>
                      <dd class="text-sand-900 font-medium">{param.value}</dd>
                    </div>
                  ))}
                </dl>
              </div>
            )}

            <!-- Contact Card -->
            <div class="bg-accent-700 text-white p-6">
              <h3 class="font-heading text-lg mb-4">Máte zájem o tuto nemovitost?</h3>
              <p class="text-white/80 text-sm mb-6">
                Kontaktujte mě pro více informací nebo domluvení prohlídky.
              </p>
              <div class="space-y-3">
                <a 
                  href={`tel:${phone.replace(/\s/g, '')}`}
                  class="flex items-center gap-3 text-white hover:text-accent-200 transition-colors"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  <span>{phone}</span>
                </a>
                <a 
                  href={`mailto:${email}`}
                  class="flex items-center gap-3 text-white hover:text-accent-200 transition-colors"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <span>{email}</span>
                </a>
              </div>
              <a href="/kontakt" class="btn bg-white text-accent-800 hover:bg-sand-100 w-full mt-6">
                Napsat zprávu
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
