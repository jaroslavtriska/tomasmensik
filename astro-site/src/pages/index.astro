---
import Layout from '../layouts/Layout.astro';
import PropertyCard from '../components/PropertyCard.astro';
import { client, queries, formatPrice, urlFor } from '../lib/sanity';
import type { SanityProperty, SanityService, SanitySiteSettings } from '../lib/sanity';

// Fetch data from Sanity with error handling
let siteSettings: SanitySiteSettings | null = null;
let sanityServices: SanityService[] = [];
let sanityProperties: SanityProperty[] = [];

try {
  siteSettings = await client.fetch<SanitySiteSettings>(queries.siteSettings);
  sanityServices = await client.fetch<SanityService[]>(queries.allServices) || [];
  sanityProperties = await client.fetch<SanityProperty[]>(queries.featuredProperties) || [];
} catch (error) {
  console.error('Error fetching data from Sanity:', error);
  sanityServices = [];
  sanityProperties = [];
}

// Transform properties for PropertyCard (use urlFor for correct image URLs)
const featuredProperties = sanityProperties.map(p => ({
  title: p.title,
  slug: p.slug.current,
  location: p.location,
  price: formatPrice(p.price),
  type: p.type === 'prodej' ? 'Prodej' : 'Pronájem',
  image: p.mainImage ? urlFor(p.mainImage).width(800).height(600).auto('format').url() : 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&h=600&fit=crop',
  area: p.area ? `${p.area} m²` : undefined,
}));

const services = sanityServices.slice(0, 3).map(s => ({
  title: s.title,
  description: s.description,
  icon: s.icon,
}));

const phone = siteSettings?.phone || '+420 123 456 789';
const email = siteSettings?.email || 'tomas@mensik-reality.cz';

// Helper to get video URL from Sanity file asset
const getVideoUrl = (fileAsset: { asset: { _ref: string } } | undefined) => {
  if (!fileAsset?.asset?._ref) return null;
  const ref = fileAsset.asset._ref;
  const fileId = ref.replace('file-', '').replace(/-mp4$/, '').replace(/-webm$/, '').replace(/-mov$/, '');
  return `https://cdn.sanity.io/files/${import.meta.env.PUBLIC_SANITY_PROJECT_ID || '2mnybhg0'}/${import.meta.env.PUBLIC_SANITY_DATASET || 'production'}/${fileId}.mp4`;
};

const heroImageUrl = siteSettings?.heroImage ? urlFor(siteSettings.heroImage).width(1920).height(1080).auto('format').url() : 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=1920&h=1080&fit=crop';
const heroVideoUrl = siteSettings?.heroVideo?.url || (siteSettings?.heroVideo?.file ? getVideoUrl(siteSettings.heroVideo.file) : null);
const hasHeroVideo = !!heroVideoUrl;
---

<Layout title="Úvod">
  <!-- Hero Section -->
  <section class="relative min-h-[90vh] flex items-center">
    <div class="absolute inset-0 z-0">
      {hasHeroVideo ? (
        <video 
          src={heroVideoUrl} 
          autoplay 
          muted 
          loop 
          playsinline
          class="w-full h-full object-cover"
        ></video>
      ) : (
        <img 
          src={heroImageUrl} 
          alt="" 
          class="w-full h-full object-cover"
        />
      )}
      <div class="absolute inset-0 bg-black/30"></div>
      <div class="absolute inset-0 bg-black/65"></div>
    </div>

    <div class="container-narrow relative z-10 py-20">
      <div class="max-w-2xl">
        {siteSettings?.heroTagline && (
          <p class="text-accent-400 font-medium tracking-widest uppercase text-sm mb-4 animate-fade-in">
            {siteSettings.heroTagline}
          </p>
        )}
        <h1 class="font-heading text-5xl md:text-6xl lg:text-7xl text-white mb-6 animate-fade-in animate-delay-100">
          {siteSettings?.heroTitle || 'Tomáš Menšík'}
        </h1>
        <p class="text-white/80 text-lg md:text-xl leading-relaxed mb-8 animate-fade-in animate-delay-200">
          {siteSettings?.heroSubtitle || 'Pomohu vám najít vysněný domov nebo prodat vaši nemovitost za nejlepší cenu. Profesionální přístup a osobní péče v Jihlavě a okolí.'}
        </p>
        <div class="flex flex-wrap gap-4 animate-fade-in animate-delay-300">
          <a href="/nemovitosti" class="btn btn-primary">
            {siteSettings?.heroCtaOffer || 'Prohlédnout nabídku'}
          </a>
          <a href="/kontakt" class="btn bg-white/10 backdrop-blur-sm border border-white/30 text-white hover:bg-white/20 hover:border-white/50 transition-all">
            {siteSettings?.heroCtaContact || 'Kontaktujte mě'}
          </a>
        </div>

        <!-- Quick Contact -->
        <div class="flex flex-wrap items-center gap-6 mt-12 pt-8 border-t border-white/20 animate-fade-in animate-delay-400">
          <a href={`tel:${phone.replace(/\s/g, '')}`} class="flex items-center gap-3 text-sand-300 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <span>{phone}</span>
          </a>
          <a href={`mailto:${email}`} class="flex items-center gap-3 text-sand-300 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span>{email}</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Services Preview -->
  <section class="py-24 bg-white">
    <div class="container-narrow">
      <div class="text-center mb-16">
        <h2 class="font-heading text-4xl md:text-5xl text-sand-900 mb-4">{siteSettings?.servicesSectionTitle || 'Co pro vás mohu udělat'}</h2>
        <p class="text-sand-600 max-w-2xl mx-auto">
          {siteSettings?.servicesSectionDescription || 'Nabízím kompletní služby v oblasti nemovitostí. Od prvního kontaktu až po úspěšný prodej.'}
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {services.length > 0 ? services.map((service) => (
          <div class="group p-8 bg-white border border-sand-200 hover:border-accent-300 hover:shadow-md transition-all duration-300 cursor-pointer">
            <div class="w-14 h-14 rounded-full bg-accent-100 group-hover:bg-accent-200 flex items-center justify-center mb-6 transition-colors">
              {service.icon === 'home' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
              )}
              {service.icon === 'chart' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              )}
              {service.icon === 'chat' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              )}
              {service.icon === 'key' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              )}
              {service.icon === 'search' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              )}
              {service.icon === 'document' && (
                <svg class="w-7 h-7 text-accent-700 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              )}
            </div>
            <h3 class="font-heading text-2xl text-sand-900 group-hover:text-accent-700 mb-3 transition-colors">
              {service.title}
            </h3>
            <p class="text-sand-600 transition-colors">
              {service.description}
            </p>
          </div>
        )) : (
          <div class="col-span-3 text-center py-8">
            <p class="text-sand-500">Služby budou brzy přidány.</p>
          </div>
        )}
      </div>

      <div class="text-center mt-12">
        <a href="/sluzby" class="btn btn-outline">
          {siteSettings?.servicesCtaLabel || 'Všechny služby'}
        </a>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-24 bg-accent-800 text-white">
    <div class="container-narrow text-center">
      <h2 class="font-heading text-4xl md:text-5xl mb-6">
        {siteSettings?.ctaTitle || 'Chcete prodat nemovitost?'}
      </h2>
      <p class="text-white/80 max-w-2xl mx-auto mb-8 text-lg">
        {siteSettings?.ctaDescription || 'Kontaktujte mě pro nezávaznou konzultaci. Pomohu vám s oceněním, přípravou a prodejem vaší nemovitosti za nejlepší možnou cenu.'}
      </p>
      <a href="/kontakt" class="btn bg-white text-accent-800 hover:bg-accent-50 hover:shadow-md transition-all">
        {siteSettings?.ctaButtonLabel || 'Domluvit schůzku'}
      </a>
    </div>
  </section>
</Layout>
