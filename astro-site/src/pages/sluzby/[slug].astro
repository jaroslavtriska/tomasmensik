---
import Layout from '../../layouts/Layout.astro';
import PortableText from '../../components/PortableText.astro';
import { client, queries, urlFor } from '../../lib/sanity';
import type { SanityService, SanitySiteSettings } from '../../lib/sanity';

export async function getStaticPaths() {
  try {
    const services = await client.fetch<SanityService[]>(queries.allServices) || [];
    
    return services
      .filter((service) => service.slug?.current)
      .map((service) => ({
        params: { slug: service.slug!.current },
      }));
  } catch (error) {
    console.error('Error fetching services for static paths:', error);
    return [];
  }
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/sluzby', 302);
}

// Fetch service by slug
let service: SanityService | null = null;
try {
  service = await client.fetch<SanityService>(queries.serviceBySlug, { slug });
  if (!service) {
    console.warn(`Service with slug "${slug}" not found`);
  } else {
    // Debug: log detailedDescription to see if it's loaded
    console.log('Service detailedDescription:', service.detailedDescription);
  }
} catch (error) {
  console.error('Error fetching service:', error);
}

// If service not found, redirect to services page
if (!service || !service.slug?.current) {
  console.warn(`Redirecting to /sluzby - service not found for slug: ${slug}`);
  return Astro.redirect('/sluzby', 302);
}

let siteSettings: SanitySiteSettings | null = null;
try {
  siteSettings = await client.fetch<SanitySiteSettings>(queries.siteSettings);
} catch (error) {
  console.error('Error fetching site settings:', error);
  siteSettings = null;
}

const phone = siteSettings?.phone || '+420 123 456 789';
const email = siteSettings?.email || 'tomas@mensik-reality.cz';
---

<Layout title={service.title} description={service.description}>
  <!-- Hero -->
  <section class="py-20 bg-sand-100">
    <div class="container-narrow">
      <div class="max-w-3xl">
        <nav class="flex items-center gap-2 text-sm text-sand-500 mb-4">
          <a href="/" class="hover:text-accent-700 transition-colors">Úvod</a>
          <span>/</span>
          <a href="/sluzby" class="hover:text-accent-700 transition-colors">Služby</a>
          <span>/</span>
          <span class="text-sand-900">{service.title}</span>
        </nav>
        <p class="text-accent-700 font-medium tracking-widest uppercase text-sm mb-4 animate-fade-in">
          Služba
        </p>
        <h1 class="font-heading text-5xl md:text-6xl text-sand-900 mb-6 animate-fade-in animate-delay-100">
          {service.title}
        </h1>
        <p class="text-sand-600 text-xl animate-fade-in animate-delay-200">
          {service.description}
        </p>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-24">
    <div class="container-narrow">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Left Column - Content -->
        <div class="lg:col-span-2">
          {service.detailedDescription && Array.isArray(service.detailedDescription) && service.detailedDescription.length > 0 ? (
            <div class="mb-12">
              <PortableText content={service.detailedDescription} />
            </div>
          ) : service.detailedDescription ? (
            <div class="mb-12 prose prose-lg max-w-none text-sand-700">
              <p>{service.detailedDescription}</p>
            </div>
          ) : null}

          {service.features && service.features.length > 0 && (
            <div class="mb-12">
              <h2 class="font-heading text-2xl text-sand-900 mb-6">Co zahrnuje tato služba</h2>
              <ul class="space-y-3">
                {service.features.map((feature: string) => (
                  <li class="flex items-start gap-3 text-sand-700">
                    <svg class="w-6 h-6 text-accent-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          <!-- Gallery -->
          {service.gallery && service.gallery.length > 0 && (
            <div class="mt-12">
              <h2 class="font-heading text-2xl text-sand-900 mb-6">Galerie</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {service.gallery.map((item: any, index: number) => (
                  <div class="aspect-video overflow-hidden bg-sand-100">
                    {item.type === 'image' && item.image && (
                      <img 
                        src={urlFor(item.image).width(800).height(600).auto('format').url()} 
                        alt={`${service.title} - obrázek ${index + 1}`}
                        class="w-full h-full object-cover"
                      />
                    )}
                    {item.type === 'video' && item.videoUrl && (
                      <div class="w-full h-full">
                        {item.videoUrl.includes('youtube.com') || item.videoUrl.includes('youtu.be') ? (
                          <iframe
                            src={item.videoUrl.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}
                            class="w-full h-full"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                            muted
                          ></iframe>
                        ) : item.videoUrl.includes('vimeo.com') ? (
                          <iframe
                            src={item.videoUrl.replace('vimeo.com/', 'player.vimeo.com/video/')}
                            class="w-full h-full"
                            frameborder="0"
                            allow="autoplay; fullscreen; picture-in-picture"
                            allowfullscreen
                            muted
                          ></iframe>
                        ) : (
                          <video
                            src={item.videoUrl}
                            class="w-full h-full object-cover"
                            controls
                            muted
                            playsinline
                          ></video>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <!-- Right Column - Contact Card -->
        <div class="lg:col-span-1">
          <div class="sticky top-28">
            <div class="bg-accent-700 text-white p-6">
              <h3 class="font-heading text-lg mb-4">Máte zájem o tuto službu?</h3>
              <p class="text-white/80 text-sm mb-6">
                Kontaktujte mě pro více informací nebo nezávaznou konzultaci.
              </p>
              <div class="space-y-3 mb-6">
                <a 
                  href={`tel:${phone.replace(/\s/g, '')}`}
                  class="flex items-center gap-3 text-white hover:text-accent-200 transition-colors"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  <span>{phone}</span>
                </a>
                <a 
                  href={`mailto:${email}`}
                  class="flex items-center gap-3 text-white hover:text-accent-200 transition-colors"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <span>{email}</span>
                </a>
              </div>
              <a href="/kontakt" class="btn bg-white text-accent-800 hover:bg-sand-100 w-full">
                Napsat zprávu
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
